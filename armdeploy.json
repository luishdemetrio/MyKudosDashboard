{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {

		"baseResourceName": {
			"type": "string",
			"minLength": 1,
			"metadata": {
				"description": "The base name to use for the resources that will be provisioned."
			}
		},

		"sites_Recognition_name": {
			"defaultValue": "recognition",
			"type": "String"
		},


		"databaseAccounts_mykudos_name": {
			"defaultValue": "mykudos",
			"type": "String"

		},

		"hostingPlanSku": {
			"type": "string",
			"allowedValues": [
				"Basic",
				"Standard",
				"Premium"
			],
			"defaultValue": "Standard",
			"metadata": {
				"description": "The pricing tier for the hosting plan."
			}
		},
		"hostingPlanSize": {
			"type": "string",
			"allowedValues": [
				"1",
				"2",
				"3"
			],
			"defaultValue": "2",
			"metadata": {
				"description": "The size of the hosting plan (small, medium, or large)."
			}
		},
		"location": {
			"type": "string",
			"defaultValue": "[resourceGroup().location]",
			"metadata": {
				"description": "Location for all resources."
			}
		},

		"DefaultCulture": {
			"defaultValue": "en-US",
			"allowedValues": [
				"ar-SA",
				"de-DE",
				"en-US",
				"es-ES",
				"fr-FR",
				"he-IL",
				"ja-JP",
				"ko-KR",
				"pt-BR",
				"ru-RU",
				"zh-CN",
				"zh-TW"
			],
			"minLength": 1,
			"type": "String",
			"metadata": {
				"description": "Default culture."
			}
		},
		"SupportedCultures": {
			"defaultValue": "ar-SA,de-DE,en-US,es-ES,fr-FR,he-IL,ja-JP,ko-KR,pt-BR,ru-RU,zh-CN,zh-TW",
			"minLength": 1,
			"type": "String",
			"metadata": {
				"description": "Comma-delimited list of the supported cultures."
			}
		},

		"gitRepoUrl": {
			"type": "string",
			"metadata": {
				"description": "The URL to the GitHub repository to deploy."
			},
			"defaultValue": "https://github.com/luishdemetrio/MyKudosDashboard.git"
		},

		"gitBranch": {
			"type": "string",
			"metadata": {
				"description": "The branch of the GitHub repository to deploy."
			},
			"defaultValue": "master"
		}
	},

	"variables": {

		"hostingPlanName": "[parameters('baseResourceName')]",
		"sharedSkus": [
			"Free",
			"Shared"
		],

		"isSharedPlan": "[contains(variables('sharedSkus'), parameters('hostingPlanSku'))]",
		"skuFamily": "[if(equals(parameters('hostingPlanSku'), 'Shared'), 'D', take(parameters('hostingPlanSku'), 1))]",
		"i18n:DefaultCulture": "[parameters('DefaultCulture')]",
		"i18n:SupportedCultures": "[parameters('SupportedCultures')]",
		"subscriptionTenantId": "[subscription().tenantId]",

		"recognition_appservice": "[concat(parameters('baseResourceName'), parameters('sites_Recognition_name') )]",

		"recognition_appserviceplan": "[concat(variables('recognition_appservice'), 'plan' )]"


	},
	"resources": [

		{
			"type": "Microsoft.Web/serverfarms",
			"apiVersion": "2022-03-01",
			"name": "[variables('recognition_appserviceplan')]",
			"location": "[parameters('location')]",
			"sku": {
				"name": "[if(variables('isSharedPlan'), concat(variables('skuFamily'), '1'), concat(variables('skuFamily'), parameters('hostingPlanSize')))]",
				"tier": "[parameters('hostingPlanSku')]",
				"size": "[concat(variables('skuFamily'), parameters('hostingPlanSize'))]",
				"family": "[variables('skuFamily')]",
				"capacity": 1
			},
			"kind": "app",
			"properties": {
				"perSiteScaling": false,
				"elasticScaleEnabled": false,
				"maximumElasticWorkerCount": 1,
				"isSpot": false,
				"reserved": false,
				"isXenon": false,
				"hyperV": false,
				"targetWorkerCount": 0,
				"targetWorkerSizeId": 0,
				"zoneRedundant": false
			}
		},
		{
			"type": "Microsoft.Web/sites",
			"apiVersion": "2022-03-01",
			"name": "[variables('recognition_appservice')]",
			"location": "[parameters('location')]",
			"dependsOn": [
				"[resourceId('Microsoft.Web/serverfarms', variables('recognition_appserviceplan'))]"
			],

			"resources": [
				{
					"apiVersion": "2015-08-01",
					"name": "appsettings",
					"type": "config",
					"dependsOn": [
						"[resourceId('Microsoft.Web/sites', variables('recognition_appservice'))]"
					],
					"properties": {
						"PROJECT": "MyKudos.Recognition.Api/MyKudos.Recognition.Api.csproj",
						"SCM_COMMAND_IDLE_TIMEOUT": "120",
						"CosmosDb__AccountEndPoint": "",
						"CosmosDb__AccountKey": "",
						"CosmosDb__DatabaseName": ""

					}
				},
				{
					"apiVersion": "2016-08-01",
					"name": "web",
					"type": "sourcecontrols",
					"condition": "[not(empty(parameters('gitRepoUrl')))]",
					"dependsOn": [
						"[resourceId('Microsoft.Web/sites', variables('recognition_appservice'))]",
						"[resourceId('Microsoft.Web/sites/config', variables('recognition_appservice'), 'appsettings')]"
					],
					"properties": {
						"RepoUrl": "[parameters('gitRepoUrl')]",
						"branch": "[parameters('gitBranch')]",
						"IsManualIntegration": true
					}
				}
			],

			"kind": "app",
			"identity": {
				"type": "SystemAssigned"
			},
			"properties": {
				"enabled": true,
				"hostNameSslStates": [
					{
						"name": "[concat( variables('recognition_appservice'), '.azurewebsites.net' )]",
						"sslState": "Disabled",
						"hostType": "Standard"
					},
					{
						"name": "[concat( variables('recognition_appservice'), '.scm.azurewebsites.net' )]",
						"sslState": "Disabled",
						"hostType": "Repository"
					}
				],
				"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('recognition_appserviceplan'))]",
				"reserved": false,
				"isXenon": false,
				"hyperV": false,
				"vnetRouteAllEnabled": false,
				"vnetImagePullEnabled": false,
				"vnetContentShareEnabled": false,
				"siteConfig": {
					"numberOfWorkers": 1,
					"acrUseManagedIdentityCreds": false,
					"alwaysOn": false,
					"http20Enabled": false,
					"functionAppScaleLimit": 0,
					"minimumElasticInstanceCount": 0
				},
				"scmSiteAlsoStopped": false,
				"clientAffinityEnabled": true,
				"clientCertEnabled": false,
				"clientCertMode": "Required",
				"hostNamesDisabled": false,
				"customDomainVerificationId": "C4D5B1C8EC9500A78A17DAB7A6A43A07B1BEC54EA34C21231227CA8832F463CA",
				"containerSize": 0,
				"dailyMemoryTimeQuota": 0,
				"httpsOnly": true,
				"redundancyMode": "None",
				"storageAccountRequired": false,
				"keyVaultReferenceIdentity": "SystemAssigned"
			}
		},
		{
			"type": "Microsoft.Web/sites/basicPublishingCredentialsPolicies",
			"apiVersion": "2022-03-01",
			"name": "[concat(variables('recognition_appservice'), '/ftp')]",
			"location": "[parameters('location')]",
			"dependsOn": [
				"[resourceId('Microsoft.Web/sites', variables('recognition_appservice'))]"
			],
			"properties": {
				"allow": true
			}
		},
		{
			"type": "Microsoft.Web/sites/basicPublishingCredentialsPolicies",
			"apiVersion": "2022-03-01",
			"name": "[concat(variables('recognition_appservice'), '/scm')]",
			"location": "[parameters('location')]",
			"dependsOn": [
				"[resourceId('Microsoft.Web/sites', variables('recognition_appservice'))]"
			],
			"properties": {
				"allow": true
			}
		},
		{
			"type": "Microsoft.Web/sites/config",
			"apiVersion": "2022-03-01",
			"name": "[concat(variables('recognition_appservice'), '/web')]",
			"location": "[parameters('location')]",
			"dependsOn": [
				"[resourceId('Microsoft.Web/sites', variables('recognition_appservice'))]"
			],
			"properties": {
				"numberOfWorkers": 1,
				"defaultDocuments": [
					"Default.htm",
					"Default.html",
					"Default.asp",
					"index.htm",
					"index.html",
					"iisstart.htm",
					"default.aspx",
					"index.php",
					"hostingstart.html"
				],
				"netFrameworkVersion": "v6.0",
				"requestTracingEnabled": false,
				"remoteDebuggingEnabled": false,
				"remoteDebuggingVersion": "VS2019",
				"httpLoggingEnabled": false,
				"acrUseManagedIdentityCreds": false,
				"logsDirectorySizeLimit": 35,
				"detailedErrorLoggingEnabled": false,
				"publishingUsername": "$KudosGatewayDev",
				"scmType": "None",
				"use32BitWorkerProcess": true,
				"webSocketsEnabled": false,
				"alwaysOn": false,
				"appCommandLine": "dotnet MyKudos.Recognition.Api.dll",
				"managedPipelineMode": "Integrated",
				"virtualApplications": [
					{
						"virtualPath": "/",
						"physicalPath": "site\\wwwroot",
						"preloadEnabled": false
					}
				],
				"loadBalancing": "LeastRequests",
				"experiments": {
					"rampUpRules": []
				},
				"autoHealEnabled": false,
				"vnetRouteAllEnabled": false,
				"vnetPrivatePortsCount": 0,
				"localMySqlEnabled": false,
				"managedServiceIdentityId": 14380,
				"ipSecurityRestrictions": [
					{
						"ipAddress": "Any",
						"action": "Allow",
						"priority": 2147483647,
						"name": "Allow all",
						"description": "Allow all access"
					}
				],
				"scmIpSecurityRestrictions": [
					{
						"ipAddress": "Any",
						"action": "Allow",
						"priority": 2147483647,
						"name": "Allow all",
						"description": "Allow all access"
					}
				],
				"scmIpSecurityRestrictionsUseMain": false,
				"http20Enabled": true,
				"minTlsVersion": "1.2",
				"scmMinTlsVersion": "1.2",
				"ftpsState": "FtpsOnly",
				"preWarmedInstanceCount": 0,
				"functionsRuntimeScaleMonitoringEnabled": false,
				"minimumElasticInstanceCount": 0,
				"azureStorageAccounts": {}
			}
		},

		{
			"type": "Microsoft.Web/sites/hostNameBindings",
			"apiVersion": "2022-03-01",
			"name": "[concat(variables('recognition_appservice'), '/', variables('recognition_appservice'), '.azurewebsites.net')]",
			"location": "[parameters('location')]",
			"dependsOn": [
				"[resourceId('Microsoft.Web/sites', variables('recognition_appservice'))]"
			],
			"properties": {
				"siteName": "variables('recognition_appservice')",
				"hostNameType": "Verified"
			}
		},

		{
			"type": "Microsoft.DocumentDB/databaseAccounts",
			"apiVersion": "2022-08-15",
			"name": "[parameters('databaseAccounts_mykudos_name')]",
			"location": "West US",
			"tags": {
				"defaultExperience": "Core (SQL)",
				"hidden-cosmos-mmspecial": ""
			},
			"kind": "GlobalDocumentDB",
			"identity": {
				"type": "None"
			},
			"properties": {
				"publicNetworkAccess": "Enabled",
				"enableAutomaticFailover": false,
				"enableMultipleWriteLocations": false,
				"isVirtualNetworkFilterEnabled": false,
				"virtualNetworkRules": [],
				"disableKeyBasedMetadataWriteAccess": false,
				"enableFreeTier": false,
				"enableAnalyticalStorage": false,
				"analyticalStorageConfiguration": {
					"schemaType": "WellDefined"
				},
				"databaseAccountOfferType": "Standard",
				"defaultIdentity": "FirstPartyIdentity",
				"networkAclBypass": "None",
				"disableLocalAuth": false,
				"enablePartitionMerge": false,
				"consistencyPolicy": {
					"defaultConsistencyLevel": "Session",
					"maxIntervalInSeconds": 5,
					"maxStalenessPrefix": 100
				},
				"locations": [
					{
						"locationName": "West US",
						"provisioningState": "Succeeded",
						"failoverPriority": 0,
						"isZoneRedundant": false
					}
				],
				"cors": [],
				"capabilities": [
					{
						"name": "EnableServerless"
					}
				],
				"ipRules": [],
				"backupPolicy": {
					"type": "Periodic",
					"periodicModeProperties": {
						"backupIntervalInMinutes": 240,
						"backupRetentionIntervalInHours": 8,
						"backupStorageRedundancy": "Geo"
					}
				},
				"networkAclBypassResourceIds": [],
				"capacity": {
					"totalThroughputLimit": 4000
				},
				"keysMetadata": {}
			}
		},
		{
			"type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
			"apiVersion": "2022-08-15",
			"name": "[concat(parameters('databaseAccounts_mykudos_name'), '/dashboard-db')]",
			"dependsOn": [
				"[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_mykudos_name'))]"
			],
			"properties": {
				"resource": {
					"id": "recognition-db"
				}
			}
		},
		{
			"type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
			"apiVersion": "2022-08-15",
			"name": "[concat(parameters('databaseAccounts_mykudos_name'), '/kudos-db')]",
			"dependsOn": [
				"[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_mykudos_name'))]"
			],
			"properties": {
				"resource": {
					"id": "kudos-db"
				}
			}
		},
		{
			"type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions",
			"apiVersion": "2022-08-15",
			"name": "[concat(parameters('databaseAccounts_mykudos_name'), '/00000000-0000-0000-0000-000000000001')]",
			"dependsOn": [
				"[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_mykudos_name'))]"
			],
			"properties": {
				"roleName": "Cosmos DB Built-in Data Reader",
				"type": "BuiltInRole",
				"assignableScopes": [
					"[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_mykudos_name'))]"
				],
				"permissions": [
					{
						"dataActions": [
							"Microsoft.DocumentDB/databaseAccounts/readMetadata",
							"Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/executeQuery",
							"Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/readChangeFeed",
							"Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/items/read"
						],
						"notDataActions": []
					}
				]
			}
		},
		{
			"type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions",
			"apiVersion": "2022-08-15",
			"name": "[concat(parameters('databaseAccounts_mykudos_name'), '/00000000-0000-0000-0000-000000000002')]",
			"dependsOn": [
				"[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_mykudos_name'))]"
			],
			"properties": {
				"roleName": "Cosmos DB Built-in Data Contributor",
				"type": "BuiltInRole",
				"assignableScopes": [
					"[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_mykudos_name'))]"
				],
				"permissions": [
					{
						"dataActions": [
							"Microsoft.DocumentDB/databaseAccounts/readMetadata",
							"Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/*",
							"Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers/items/*"
						],
						"notDataActions": []
					}
				]
			}
		},
		{
			"type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
			"apiVersion": "2022-08-15",
			"name": "[concat(parameters('databaseAccounts_mykudos_name'), '/kudos-db/KudosDbContext')]",
			"dependsOn": [
				"[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('databaseAccounts_mykudos_name'), 'kudos-db')]",
				"[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_mykudos_name'))]"
			],
			"properties": {
				"resource": {
					"id": "KudosDbContext",
					"indexingPolicy": {
						"indexingMode": "consistent",
						"automatic": true,
						"includedPaths": [
							{
								"path": "/*"
							}
						],
						"excludedPaths": [
							{
								"path": "/\"_etag\"/?"
							}
						]
					},
					"partitionKey": {
						"paths": [
							"/__partitionKey"
						],
						"kind": "Hash",
						"version": 2
					},
					"conflictResolutionPolicy": {
						"mode": "LastWriterWins",
						"conflictResolutionPath": "/_ts"
					}
				}
			}
		},
		{
			"type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
			"apiVersion": "2022-08-15",
			"name": "[concat(parameters('databaseAccounts_mykudos_name'), '/dashboard-db/RecognitionDbContext')]",
			"dependsOn": [
				"[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('databaseAccounts_mykudos_name'), 'dashboard-db')]",
				"[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('databaseAccounts_mykudos_name'))]"
			],
			"properties": {
				"resource": {
					"id": "RecognitionDbContext",
					"indexingPolicy": {
						"indexingMode": "consistent",
						"automatic": true,
						"includedPaths": [
							{
								"path": "/*"
							}
						],
						"excludedPaths": [
							{
								"path": "/\"_etag\"/?"
							}
						]
					},
					"partitionKey": {
						"paths": [
							"/__partitionKey"
						],
						"kind": "Hash",
						"version": 2
					},
					"conflictResolutionPolicy": {
						"mode": "LastWriterWins",
						"conflictResolutionPath": "/_ts"
					}
				}
			}
		}
	]
	}